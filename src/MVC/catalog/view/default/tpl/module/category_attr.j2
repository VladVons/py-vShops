<!-- category_attr + -->
{% set DblAttr = TDbList().Import(dbl_category_attr) %}
{% if DblAttr.GetSize() > 0 %}
<div class="container mt-3">
  {% if title %}
    <h2 class="fw-bold">{{ title }}</h2>
  {% endif %}

  {% if descr %}
    <div class="pt-4">
    {{ descr }}
    </div>
  {% endif %}

  <div class="mt-3">
    <form method="get">
      {% for Rec in DblAttr %}
        <div class="fw-bold mt-2">{{Rec.title}}</div>
        {% for Attr, Count in Rec.attrs.items() %}
        <div>
          <input class="form-check-input attrChk" type="checkbox" id="{{Rec.attr_id}}_{{Attr}}" attrId="{{Rec.attr_id}}" value='{{Attr}}'>
          <label class="form-check-label" for="{{Rec.attr_id}}_{{Attr}}" disabled>{{Attr}} ({{Count}})</label>
        </div>
        {%- endfor %}
      {%- endfor %}
      <div class="mt-2">
        <button type="submit" class="btn btn-primary">{{lang.submit}}</button>
      </div>
    </form>
  </div>
</div>
{% endif %}

<script>
  function getChecked(aItems) {
    let Res = {}
    for (var xItem of aItems) {
      if (xItem.checked) {
        const attrId = xItem.getAttribute('attrId')
        if (attrId in Res) {
          Res[attrId].push(xItem.value)
        }else{
          Res[attrId] = [xItem.value]
        }
      }
    }
    return Res
  }

  function setChkEnabled(aItems, aEnable, aElement) {
    const attrIdCur = aElement.getAttribute('attrId')
    for (var xItem of Items) {
      const attrId = xItem.getAttribute('attrId')
      if (aEnable) {
        xItem.disabled = !aEnable
      }else if (attrIdCur != attrId) {
        xItem.disabled = !aEnable
      }
    }
  }

  const Items = document.querySelectorAll(".attrChk")
  Items.forEach(function (element) {
    element.addEventListener('click', function (event) {
      const checked = getChecked(Items)
      console.log('q1', checked)
      if (Object.keys(checked).length > 0) {
        setChkEnabled(Items, false, event.target)

        const post = {
          'items': checked,
          'category_id': '{{category_id}}',
          'lang_id': '{{lang_id}}'
        }
        const data = new TSend().exec('/api/?route=module/category_attr', {'method': 'ajax', 'post': post})
        let Dbl = new TDbList().Import(data)
        for (let Rec of Dbl) {
          const attrId = Rec.GetField('attr_id')
          const attrVal = Rec.GetField('val')
          const attrCount = Rec.GetField('count')
          const id = `${attrId}_${attrVal}`
          const element = document.getElementById(id)
          if (element) {
            //element.childNodes[1].textContent = `${attrVal} (${attrCount})`
            //element.nextSibling.data = `-${attrVal} (${attrCount})`
            element.disabled = false
            //console.log('-x1', element.nextSibling)
            //element.nextSibling.disabled = true
          }
        }
      } else {
        setChkEnabled(Items, true, event.target)
      }
    })
  })
</script>
<!-- category_attr - -->
